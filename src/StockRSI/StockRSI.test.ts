import RSI, { quickRSI } from '../RSI'
import { RSIInterface } from '../RSI/types'
import { stoch, smoothedStoch } from '.'

// ETHUSD 1D Bitfinex
const rawCandles = [
    [1554940800000, 177.26, 164.17, 177.39, 160.89, 274173.62989398],
    [1554854400000, 176.8, 177.2, 186.97, 169.01, 417940.62710736],
    [1554768000000, 181.41, 176.8, 181.66, 175.52, 244210.28302129],
    [1554681600000, 176.75, 181.45, 187.98, 175, 461566.4603373],
    [1554595200000, 167.12, 176.62, 178.99, 165.86, 237570.9125227],
    [1554508800000, 167.33, 167.08, 174.32, 161.71, 256029.47361819],
    [1554422400000, 158.67, 167.07, 170, 157.76, 191292.10672533],
    [1554336000000, 161.16, 158.66, 165.37787205, 155, 305834.27061489],
    [1554249600000, 165.5, 161.17, 181.33, 151.82, 820712.91013769],
    [1554163200000, 143.14724475, 165.5, 168.5, 142.94, 575444.72376978],
    [1554076800000, 143.78, 143.20327984, 145.58, 141, 104078.57106062],
    [1553990400000, 144.65, 143.78, 144.68, 142.64, 59796.53568302],
    [1553904000000, 146.2, 144.65, 149.17, 142.03, 136087.03726621],
    [1553817600000, 140.26, 146.2, 146.6, 140, 154539.68053376],
    [1553731200000, 141.65, 140.26, 141.65, 139.42, 59669.24760584],
    [1553644800000, 135.4, 141.71, 142.19, 135.33, 177271.56245862],
    [1553558400000, 135.14155752, 135.4, 136.26, 133.9, 116634.46998784],
    [1553472000000, 137.82, 135.14, 138.76, 132.67124053, 114056.52533452],
    [1553385600000, 139.25, 137.81, 139.37, 136.69, 59308.27485209],
    [1553299200000, 137.86, 139.28, 140.7, 137.8, 81479.88887832],
    [1553212800000, 136.99, 138, 139.49, 136.15, 91039.82957107],
    [1553126400000, 142.17, 136.99, 142.78, 135, 172146.28563456],
    [1553040000000, 141.64, 142.17, 143.02, 138.77, 120367.52846823],
    [1552953600000, 140.59, 141.64, 142.34, 139.81, 82455.76275512],
    [1552867200000, 141.72, 140.6, 144.88, 138.3, 148601.34019785],
    [1552780800000, 143.79168208, 141.71, 143.79168208, 140, 119257.71049178],
    [1552694400000, 139.27, 143.79, 147.5, 139.27, 195718.24283274],
    [1552608000000, 134.71, 139.15154501, 141.19, 134.67899222, 262276.6071077],
    [1552521600000, 134.51, 134.72, 138.51, 131.56, 144525.75466461],
    [1552435200000, 136.26386055, 134.51, 136.32, 133.42, 105011.12588162],
    [1552348800000, 135.41, 136.27, 139.01, 130.55, 189902.04949047],
    [1552262400000, 138.19868858, 135.41228143, 138.76, 133.46, 168750.16984593],
    [1552176000000, 140.04, 138.2, 140.4, 136.5, 102267.33111797],
    [1552089600000, 136.19, 140.04, 141.71, 135.37, 172797.25446211],
    [1552003200000, 140.03, 136.18, 143.06280348, 131, 254452.01201008],
    [1551916800000, 140.569586, 140.04, 143.3, 138.32, 144044.54303336],
    [1551830400000, 140.03708394, 140.57, 143.83, 136.5, 236683.61694207],
    [1551744000000, 128.39, 140, 141, 127.74, 302894.16151721],
    [1551657600000, 133.27645537, 128.39, 133.88740746, 125.88, 217570.92113804],
    [1551571200000, 135.59, 133.23, 137.99, 130.4, 110320.33667254],
    [1551484800000, 138.53, 135.59746332, 139.31, 132.63, 179045.31672674],
    [1551398400000, 138.18, 138.5, 141.44, 137.81, 112400.50230288],
    [1551312000000, 137.72, 138.17, 143, 136, 327681.6547735],
    [1551225600000, 139.36, 137.71, 144.19, 128.8, 372477.60149725],
    [1551139200000, 141.17, 139.37, 141.75, 136.22, 140020.0187171],
    [1551052800000, 135.3, 141.21, 144.78, 134.96, 322418.67594558],
    [1550966400000, 161.54, 135.2, 170, 134.59, 880143.09454422],
    [1550880000000, 151.27, 161.53745825, 163.78, 148.75, 442932.81412847],
    [1550793600000, 148.30303447, 151.27, 152.43, 146.1, 349070.15586161],
    [1550707200000, 151.36, 148.3, 156.4, 145, 324665.15844687],
    [1550620800000, 146.61, 151.41, 152.99, 143.6, 315090.6354455],
    [1550534400000, 148.87, 146.61, 153.76, 145.76, 344048.26117811],
    [1550448000000, 136.17, 148.87, 152, 134.7, 677549.40613454],
    [1550361600000, 124.68, 136.15, 139.5, 124.35186336, 520129.55200444],
    [1550275200000, 123.78, 124.68, 127.25, 123.73, 122637.51885895],
    [1550188800000, 122.53, 123.75, 127.4, 122.19, 179536.51121806],
    [1550102400000, 123.85, 122.52, 126.35, 122.06, 180710.06673683],
    [1550016000000, 124.67, 123.85, 130.46398664, 122.45, 244185.72179065],
    [1549929600000, 122.68928414, 124.75, 127, 119.22, 226671.65242257],
    [1549843200000, 127.31, 122.68388757, 127.31, 121.21, 207173.08194556],
    [1549756800000, 121.08, 127.37, 128.16, 118, 249140.41491205],
    [1549670400000, 121.22, 121.01, 123.73, 119.55, 146997.10960893],
    [1549584000000, 105.78, 121.21040371, 124.88, 105.00230043, 520022.74559365],
    [1549497600000, 106.06, 105.81, 107.75, 104.76, 115100.64330285],
    [1549411200000, 108.69, 106.05, 109, 102.49, 280564.98488924],
    [1549324800000, 108.45, 108.69, 109.17, 107.36, 66832.69763122],
    [1549238400000, 108.58, 108.46, 110.6, 107.77, 105145.61749952],
    [1549152000000, 112.7, 108.63, 114.2, 107, 191424.8820344],
    [1549065600000, 109.01, 112.71, 114.33389877, 107.93, 163361.18595986],
    [1548979200000, 108.61, 108.93639624, 110.67, 105.51, 192631.45359719],
    [1548892800000, 110.55125732, 108.49, 113.88, 107.17, 179435.26128464],
    [1548806400000, 106.32, 110.62, 112.06, 105.07, 324022.8745867],
    [1548720000000, 107.5, 106.3, 108.36, 104.16, 164515.21696698],
    [1548633600000, 113.44, 107.49, 114.45, 103.2, 370323.8965416],
    [1548547200000, 117.28, 113.43, 118.49, 112.16, 238132.02639151],
    [1548460800000, 117.27, 117.26, 122, 117, 136149.13182552],
    [1548374400000, 119.05, 117.26547717, 120, 116.01, 139956.70900985],
    [1548288000000, 118.75892895, 119.05314044, 120.12, 115.65, 181027.10848461],
    [1548201600000, 120.19, 118.76, 121.29, 117.03, 153142.5418661],
    [1548115200000, 117.42, 120.19, 122.12, 112.2, 298455.23310464],
    [1548028800000, 119.08, 117.5, 120.53, 114.65, 207936.02068398],
    [1547942400000, 126, 119.1, 126.87, 107.51, 370922.98978005],
    [1547856000000, 121.88, 126.01, 132.36, 121.87653566, 285043.72533233],
    [1547769600000, 125.24, 121.82, 125.66, 120.16, 146720.87929936],
    [1547683200000, 124.42, 125.25, 127.32, 119.34, 258914.71331602999],
    [1547596800000, 122.6, 124.36, 131.36, 121.38, 300508.54459523],
    [1547510400000, 131.45921456, 122.6, 134.29, 119.29, 360220.49288352],
    [1547424000000, 117.94, 131.45, 134.5, 117.79, 380637.93611058],
    [1547337600000, 127.39, 117.94, 128.06, 116.1, 245786.59389878],
    [1547251200000, 128.76, 127.41, 130.37, 126.1, 142550.72526521],
    [1547164800000, 129.52, 128.73, 131.79, 124.43, 281137.06106823],
    [1547078400000, 152.6623428, 129.5, 154.8, 125.71, 684813.18925398],
    [1546992000000, 152.88, 152.65, 162.76, 151, 291789.53971791],
    [1546905600000, 154.79, 152.86, 158.09124123, 146, 394338.68343654],
    [1546819200000, 160.76, 154.79, 162.59, 153, 193398.32987615],
    [1546732800000, 158.36, 160.84, 165.86, 152.59, 507028.2163778],
    [1546646400000, 158.71, 158.32, 167, 155, 500826.31287689],
    [1546560000000, 152.41686459, 158.48, 162.4, 149.78, 553207.86063978],
    [1546473600000, 159.51163185, 152.42, 160.93, 149.49, 326455.87626429],
    [1546387200000, 145.05, 159.36, 163.67, 143.86, 566338.6179306]
].reverse()
const values: number[] = []
rawCandles.forEach(i => values.push(i[2]))

it('Should return the current StockRSI', () => {
    const RSIs: number[] = []
    const stochs: number[] = []
    const SRSIs: number[] = []
    const period: number = 14
    const smoothK: number = 3

    let currentRSI: RSIInterface = RSI(values.slice(0, period), period)
    RSIs.push(currentRSI.RSI)

    for (let i = period; i < values.length; i++) {
        currentRSI = quickRSI(values[i], values[i - 1], period, currentRSI.averageGain, currentRSI.averageLoss)
        RSIs.push(currentRSI.RSI)

        if (RSIs.length >= period) {
            stochs.push(stoch(RSIs.slice(i - (period - 1) * 2), period))
        }

        if (stochs.length >= smoothK) {
            SRSIs.push(smoothedStoch(stochs.slice(i - period * 2), smoothK))
        }
    }

    expect(RSIs.length).toBe(values.length - (period - 1))
    expect(SRSIs.length).toBe(rawCandles.length - period * 2)

    // tested manually first, with TradingView
    expect(RSIs).toEqual([
        27.291821102050903,
        28.95548167821258,
        29.829852923953098,
        28.380182515547915,
        32.68388081744372,
        29.532128596648334,
        28.838670375665615,
        31.740716150831958,
        31.016576211379203,
        31.362271185693245,
        30.36299042038239,
        30.35979863195392,
        28.13275344015061,
        25.06216832601544,
        24.485581750279692,
        30.717093939488763,
        29.427657894225476,
        30.090003363040395,
        35.593050356341806,
        32.60469252322801,
        32.48231888895148,
        32.84953386007035,
        30.780179871925796,
        30.59151175510017,
        51.24361896699058,
        51.030833100134,
        57.11675860740259,
        51.98977287773581,
        53.95237264501154,
        52.937217695288794,
        51.39813152925746,
        52.76584806924387,
        53.82393791593086,
        64.41235099920334,
        72.06305323586211,
        69.2158808522117,
        71.76724174747697,
        67.84386870622981,
        69.55554746340182,
        74.59098755364097,
        51.19828953549899,
        54.690261947871534,
        53.42975008515299,
        52.2595040826998,
        52.569521402547636,
        52.80628991370109,
        50.42212631677517,
        48.498720591245394,
        44.74117770461818,
        53.95655314705109,
        54.35898653734815,
        53.88735940732647,
        50.454000876606386,
        53.635299219333646,
        51.923797049519855,
        49.354190852985916,
        50.17126331174222,
        48.444187996353115,
        48.67123114355041,
        53.34091557417561,
        57.68069881238337,
        55.20124856554922,
        53.87042759789029,
        54.96591434325399,
        55.545306395216855,
        48.920668557320205,
        50.16860962354573,
        51.77658757818925,
        49.78954448009913,
        46.31294343550924,
        46.70321283755036,
        55.212487564284665,
        53.113918879452235,
        59.84690907260391,
        57.5254860835887,
        56.207594178621136,
        55.30311279235842,
        73.23515872565582,
        67.5660752391191,
        64.45151411485682,
        69.52111929390927,
        69.52668424599597,
        74.34007254288179,
        76.37473043770318,
        70.57290727102252,
        70.77854761280021,
        56.8434376188892
    ])
    expect(SRSIs).toEqual([
        25.336605955933923,
        45.43051447467318,
        68.21744286411447,
        76.21417024151388,
        80.48558161368466,
        81.69673182127977,
        73.46348326401585,
        67.98815035661079,
        62.31386878112093,
        70.54711733838485,
        84.72538960332767,
        99.73492591511446,
        94.49761789308029,
        90.9532677148837,
        85.92175615201477,
        84.10601985254826,
        82.44780974903942,
        83.34135078417331,
        90.394395105674,
        95.86202947226495,
        97.71154524927158,
        97.47378261508675,
        90.78692390908795,
        89.10130815231487,
        89.3390707864997,
        62.69259615916516,
        38.30920573258142,
        8.15558336136599,
        9.667756870064858,
        6.645815944055699,
        5.757418816928852,
        4.2452453082299835,
        2.2913138349910596,
        0,
        10.290825401170407,
        21.031048852481977,
        31.24460548703422,
        27.333299420473836,
        46.391870502259536,
        60.242905037734936,
        69.85113380873423,
        58.87189128782065,
        47.64116680592184,
        45.274169910498166,
        56.259528140420116,
        76.75899478562462,
        90.08429712671455,
        79.86196054117399,
        70.0646661472138,
        68.74560003127844,
        50.88258105092342,
        33.569749343296365,
        19.968946716663535,
        23.10460382097095,
        16.881396589224867,
        5.999587221116951,
        27.240245832275082,
        47.18254525278774,
        79.3715031455216,
        80.89144260770357,
        85.31906552045508,
        74.12797193639477,
        79.84549541587052,
        81.7898165113884,
        82.10557348076607,
        77.50709177867292,
        79.93459014231914,
        90.80992675700179,
        95.40840845909493,
        91.68584014914035,
        83.66636812729692,
        52.76968497187257
    ])
})
